
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zeiterfassung</title>
<link rel="manifest" href="/Zeiterfassung/manifest.json">
<link rel="icon" href="/Zeiterfassung/assets/logo.png">
<style>
:root{--bg:#faf6f6;--ink:#1d1d1d;--card:#fff;--line:#ddd;--btn:#8c7b6a;--mut:#666}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
header{background:#d9c9b9;color:#2b261f;padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
.wrap{max-width:1080px;margin:16px auto;padding:0 12px}
.card{background:var(--card);border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin:12px 0}
label{display:block;font-size:12px;margin-bottom:4px;color:#555}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;font:inherit}
textarea{resize:vertical;min-height:40px}
button{background:var(--btn);color:#fff;border:0;padding:10px 16px;border-radius:10px;font:inherit;cursor:pointer}
button.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.row-inline{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:end}
@media(max-width:720px){.row,.row-3,.row-inline{grid-template-columns:1fr}}
.range-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
table{width:100%;border-collapse:collapse;margin-top:6px}
th,td{border-bottom:1px solid var(--line);text-align:left;padding:10px;font-size:14px}
th{font-weight:600}
/* Foto UI */
#photoGallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-top:10px}
#photoGallery figure{margin:0;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:#fff}
#photoGallery img{display:block;width:100%;height:110px;object-fit:cover}
#photoGallery figcaption{font-size:12px;color:#666;text-align:center;padding:6px}
.muted{color:var(--mut)}
</style>
</head>
<body>
<header>
  <strong>Zeiterfassung</strong>
  <nav><a href="/Zeiterfassung/users/" style="color:#2b261f;text-decoration:none">Mitarbeiterverwaltung</a></nav>
</header>

<main class="wrap">
  <section class="card">
    <h2>Zeiteingabe</h2>
    <div class="row-3">
      <div>
        <label>Projekt / Kostenstelle</label>
        <select id="projectSelect"></select>
      </div>
      <div>
        <label>Pausen (Minuten)</label>
        <select id="pauseMin">
          <option>0</option><option>15</option><option selected>30</option><option>45</option><option>60</option>
        </select>
      </div>
      <div>
        <label>Bemerkung</label>
        <input id="note" placeholder="z. B. Montage, Fahrzeit">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tagesstatus</label>
        <select id="status">
          <option value="work" selected>Arbeit</option>
          <option value="urlaub">Urlaub</option>
          <option value="krank">Krank</option>
        </select>
      </div>
      <div></div>
    </div>

    <div class="range-row">
      <div>
        <div class="range-row">
          <input id="startRange" type="range" min="0" max="1439" value="405">
          <span>Start</span>
        </div>
        <div class="range-row" style="margin-top:8px">
          <input id="endRange" type="range" min="0" max="1439" value="990">
          <span>Ende</span>
        </div>
      </div>
      <div>
        <label>Arbeitszeit (HH:MM)</label>
        <input id="workTime" type="text" readonly>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Datum</label>
        <input id="date" type="date">
      </div>
      <div></div>
    </div>

    <div class="card" style="padding:12px;margin:14px 0">
      <h3>Mitarbeiter auswählen</h3>
      <label style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="chkMe" checked>
        <span id="meLabel">Ich (Admin)</span>
      </label>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button id="btnSaveMine">Nur für mich speichern</button>
      </div>
    </div>
  </section>

  <section id="photoWrap" class="card">
    <h3>Fotos zum Eintrag / Projekt</h3>
    <div class="row" style="grid-template-columns:1fr auto;gap:10px;align-items:center">
      <input id="photoInput" type="file" accept="image/*" multiple capture="environment">
      <button id="btnAddPhotos" class="ghost">Fotos hinzufügen</button>
    </div>
    <div id="photoGallery"></div>
  </section>

  <section class="card">
    <h3>Übersicht Monat</h3>
    <div class="row-3">
      <div>
        <label>Monat</label>
        <input id="monthPicker" type="month">
      </div>
      <div>
        <label>Nutzer</label>
        <select id="userPicker"></select>
      </div>
      <div></div>
    </div>
    <table>
      <thead>
        <tr><th>Datum</th><th>Status</th><th>Von</th><th>Bis</th><th>Projekt</th><th>Pausen</th><th>Arbeitszeit</th><th>Aktion</th></tr>
      </thead>
      <tbody id="tblMonth"></tbody>
      <tfoot><tr><td colspan="6">Summe</td><td id="sumTime">00:00</td><td></td></tr></tfoot>
    </table>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="btnCsv" class="ghost">CSV-Export</button>
      <button id="btnPdf" class="ghost">PDF-Export</button>
    </div>
  </section>

  <section class="card">
    <h3>Projekte (Admin)</h3>
    <div class="row" style="grid-template-columns:1fr auto">
      <input id="newProjectName" placeholder="Projektname / Kostenstelle">
      <button id="btnAddProject" class="ghost">Anlegen</button>
    </div>
    <ul id="projectList"></ul>
  </section>
</main>

<script>
/*** Datenbank ***/
const DB_NAME='zeit-web-pwa';
const STORE={users:'users',projects:'projects',entries:'entries',photos:'photos'};

function openDB(version){
  return new Promise((resolve,reject)=>{
    const req = (version ? indexedDB.open(DB_NAME, version) : indexedDB.open(DB_NAME));
    req.onerror = ()=>reject(req.error);
    req.onsuccess= ()=>resolve(req.result);
    req.onupgradeneeded = (ev)=>{
      const db = ev.target.result;
      if(!db.objectStoreNames.contains(STORE.users)){
        const s=db.createObjectStore(STORE.users,{keyPath:'username'});
        s.createIndex('role','role',{unique:false}); s.createIndex('status','status',{unique:false});
      }
      if(!db.objectStoreNames.contains(STORE.projects)){
        const s=db.createObjectStore(STORE.projects,{keyPath:'id'});
        s.createIndex('name','name',{unique:false});
      }
      if(!db.objectStoreNames.contains(STORE.entries)){
        const s=db.createObjectStore(STORE.entries,{keyPath:'id'});
        s.createIndex('date','date',{unique:false});
        s.createIndex('username','username',{unique:false});
      }
      if(!db.objectStoreNames.contains(STORE.photos)){
        const s=db.createObjectStore(STORE.photos,{keyPath:'id'});
        s.createIndex('projectId','projectId',{unique:false});
        s.createIndex('createdAt','createdAt',{unique:false});
      }
    };
  });
}
function tx(db, store, mode='readonly'){ return db.transaction(store, mode).objectStore(store); }

/*** Helpers ***/
function me(){ try{return JSON.parse(localStorage.getItem('cu')||'null');}catch(e){return null;} }
function setMe(u){ localStorage.setItem('cu', JSON.stringify(u)); }
function pad(n){ return String(n).padStart(2,'0'); }
function minToHHMM(m){ const h=Math.floor(m/60), mm=m%60; return pad(h)+':'+pad(mm); }
function hhmmToMin(t){ const [h,m]=t.split(':').map(x=>+x); return h*60+m; }
function curDate(){ const d=new Date(); return d.toISOString().slice(0,10); }
function monthKey(d){ return d.slice(0,7); }

/*** Users bootstrap ***/
async function ensureBootstrap(){
  const db=await openDB(); const os=tx(db, STORE.users);
  const have=await new Promise((res,rej)=>{ const r=os.count(); r.onsuccess=()=>res(r.result>0); r.onerror=()=>rej(r.error); });
  if(!have){
    const w=tx(db, STORE.users,'readwrite');
    await new Promise((res,rej)=>{ const r=w.put({username:'admin',display:'Administrator',pass:'admin',role:'admin',status:'active'}); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  }
  if(!me()){ setMe({username:'admin',display:'Administrator',role:'admin'}); }
  document.getElementById('meLabel').textContent = `${me().display||me().username} (${me().role})`;
}

/*** Projects ***/
async function listProjects(){
  const db=await openDB(); const os=tx(db, STORE.projects);
  const items=[];
  await new Promise((res,rej)=>{ const r=os.openCursor(); r.onsuccess=e=>{const c=e.target.result; if(c){items.push(c.value); c.continue();} else res();}; r.onerror=()=>rej(r.error); });
  items.sort((a,b)=>a.name.localeCompare(b.name));
  const sel=document.getElementById('projectSelect'); sel.innerHTML='';
  for(const p of items){ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); }
  const ul=document.getElementById('projectList'); ul.innerHTML='';
  for(const p of items){
    const li=document.createElement('li'); li.textContent=p.name+' ';
    const b=document.createElement('button'); b.className='ghost'; b.textContent='Löschen';
    b.onclick=async()=>{ const db2=await openDB(); await new Promise((res,rej)=>{ const r=tx(db2,STORE.projects,'readwrite').delete(p.id); r.onsuccess=res; r.onerror=()=>rej(r.error);}); await listProjects(); refreshPhotoGallery();};
    li.appendChild(b); ul.appendChild(li);
  }
}
async function addProject(name){
  if(!name.trim()) return;
  const db=await openDB(); const os=tx(db, STORE.projects, 'readwrite');
  await new Promise((res,rej)=>{ const r=os.put({id:crypto.randomUUID(), name:name.trim()}); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  await listProjects();
}

/*** Entries ***/
async function saveEntryFor(username){
  const date=document.getElementById('date').value;
  const pid=document.getElementById('projectSelect').value;
  const status=document.getElementById('status').value;
  const start=+document.getElementById('startRange').value;
  const end=+document.getElementById('endRange').value;
  const pause=+document.getElementById('pauseMin').value;
  const note=document.getElementById('note').value.trim();
  const work=Math.max(0, end-start-pause);
  const rec={id:crypto.randomUUID(), username, date, projectId:pid, status, start, end, pause, work, note};
  const db=await openDB(); const os=tx(db, STORE.entries,'readwrite');
  await new Promise((res,rej)=>{ const r=os.put(rec); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  await renderMonth();
}

async function getEntries(month, username){
  const db=await openDB(); const os=tx(db, STORE.entries);
  const out=[];
  await new Promise((res,rej)=>{
    const r=os.openCursor(); r.onsuccess=e=>{const c=e.target.result; if(c){ const v=c.value; if(v.username===username && monthKey(v.date)===month) out.push(v); c.continue();} else res();};
    r.onerror=()=>rej(r.error);
  });
  out.sort((a,b)=>a.date.localeCompare(b.date));
  return out;
}

/*** Fotos (wie in Users-Seite) ***/
async function ensurePhotoStore(){
  let db=await openDB();
  if(!db.objectStoreNames.contains(STORE.photos)){
    const newV = db.version + 1; db.close(); db = await openDB(newV);
  }
  return db;
}

async function compressImage(file, maxW=1600, quality=0.82){
  const img=new Image();
  img.src = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});
  await new Promise(res=>img.onload=res);
  const scale=Math.min(1, maxW/img.width);
  const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
  const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return c.toDataURL('image/jpeg', quality);
}

async function addPhotosToProject(){
  const inp=document.getElementById('photoInput');
  const files=Array.from(inp.files||[]);
  if(!files.length){ alert('Bitte Fotos auswählen.'); return; }
  const pid=document.getElementById('projectSelect').value; if(!pid){ alert('Bitte zuerst ein Projekt wählen.'); return; }

  const db=await ensurePhotoStore();
  const s=tx(db, STORE.photos, 'readwrite');

  for(const f of files){
    const dataUrl=await compressImage(f);
    const rec={id:crypto.randomUUID(), projectId:pid, filename:f.name, dataUrl, createdAt:new Date().toISOString()};
    await new Promise((res,rej)=>{ const r=s.put(rec); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  }
  inp.value='';
  await refreshPhotoGallery();
}

async function refreshPhotoGallery(){
  const pid=document.getElementById('projectSelect').value;
  const wrap=document.getElementById('photoGallery'); wrap.innerHTML='';
  if(!pid) return;
  const db=await ensurePhotoStore(); const s=tx(db,STORE.photos);
  const out=[];
  await new Promise((res,rej)=>{
    const idx=s.index('projectId'); const r=idx? idx.openCursor(IDBKeyRange.only(pid)) : s.openCursor();
    r.onsuccess=e=>{ const c=e.target.result; if(c){ const v=c.value; if(!pid||v.projectId===pid) out.push(v); c.continue(); } else res(); };
    r.onerror=()=>rej(r.error);
  });
  out.sort((a,b)=>a.createdAt.localeCompare(b.createdAt));
  for(const p of out){
    const fig=document.createElement('figure');
    const img=document.createElement('img'); img.src=p.dataUrl; img.alt=p.filename||'';
    const cap=document.createElement('figcaption');
    const del=document.createElement('button'); del.className='ghost'; del.textContent='Löschen';
    del.onclick=async()=>{
      if(!confirm('Foto löschen?')) return;
      const db2=await ensurePhotoStore();
      await new Promise((res,rej)=>{ const r=tx(db2,STORE.photos,'readwrite').delete(p.id); r.onsuccess=res; r.onerror=()=>rej(r.error); });
      await refreshPhotoGallery();
    };
    cap.appendChild(del); fig.appendChild(img); fig.appendChild(cap); wrap.appendChild(fig);
  }
}

/*** Monat-UI ***/
async function renderMonth(){
  const month=document.getElementById('monthPicker').value || monthKey(curDate());
  const user=document.getElementById('userPicker').value || me().username;
  const rows=await getEntries(month, user);
  const tb=document.getElementById('tblMonth'); tb.innerHTML='';
  let sum=0;
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.date}</td><td>${r.status}</td><td>${minToHHMM(r.start)}</td><td>${minToHHMM(r.end)}</td><td>${r.projectId||''}</td><td>${r.pause}</td><td>${minToHHMM(r.work)}</td><td></td>`;
    tb.appendChild(tr);
    sum+=r.work;
  }
  document.getElementById('sumTime').textContent=minToHHMM(sum);
}

/*** Export ***/
function entriesToCsv(rows){
  const head=['Datum','Status','Von','Bis','Projekt','Pause','Arbeitszeit'];
  const csv=[head.join(';')];
  for(const r of rows) csv.push([r.date,r.status,minToHHMM(r.start),minToHHMM(r.end),r.projectId||'',r.pause,minToHHMM(r.work)].join(';'));
  return csv.join('\n');
}

/*** Event-Bindings ***/
window.addEventListener('DOMContentLoaded', async () => {
  if('serviceWorker' in navigator){ try{ await navigator.serviceWorker.register('/Zeiterfassung/sw.js',{scope:'/Zeiterfassung/'});}catch(e){} }

  await ensureBootstrap();

  document.getElementById('date').value = curDate();
  document.getElementById('monthPicker').value = monthKey(curDate());

  // default project if none
  const db=await openDB(); const count=await new Promise((res,rej)=>{ const r=tx(db,STORE.projects).count(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
  if(count===0){ await addProject('Allgemein'); }

  await listProjects();
  await refreshPhotoGallery();

  // user picker fill
  const os=tx(await openDB(), STORE.users); const users=[];
  await new Promise((res,rej)=>{ const r=os.openCursor(); r.onsuccess=e=>{ const c=e.target.result; if(c){ users.push(c.value); c.continue(); } else res(); }; r.onerror=()=>rej(r.error); });
  const up=document.getElementById('userPicker'); up.innerHTML=''; users.sort((a,b)=>a.username.localeCompare(b.username));
  for(const u of users){ const o=document.createElement('option'); o.value=u.username; o.textContent=`${u.display||u.username} (${u.role})`; if(u.username===me().username) o.selected=true; up.appendChild(o); }

  function recalc(){
    const start=+document.getElementById('startRange').value;
    const end=+document.getElementById('endRange').value;
    const pause=+document.getElementById('pauseMin').value;
    const work=Math.max(0, end-start-pause);
    document.getElementById('workTime').value = `${minToHHMM(work)} (Ü: ${minToHHMM(Math.max(0,work-8*60))})`;
  }
  ['startRange','endRange','pauseMin'].forEach(id=>document.getElementById(id).addEventListener('input',recalc));
  recalc();

  document.getElementById('btnAddProject').onclick=()=>addProject(document.getElementById('newProjectName').value).then(()=>{document.getElementById('newProjectName').value='';});
  document.getElementById('projectSelect').addEventListener('change',refreshPhotoGallery);

  document.getElementById('btnAddPhotos').onclick=(e)=>{e.preventDefault(); addPhotosToProject();};

  document.getElementById('btnSaveMine').onclick=()=>saveEntryFor(me().username);

  document.getElementById('monthPicker').addEventListener('change',renderMonth);
  document.getElementById('userPicker').addEventListener('change',renderMonth);
  document.getElementById('btnCsv').onclick=async()=>{
    const rows=await getEntries(document.getElementById('monthPicker').value, document.getElementById('userPicker').value);
    const csv=entriesToCsv(rows);
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='zeiten.csv'; a.click();
  };
  document.getElementById('btnPdf').onclick=()=>{
    const w=window.open('','_blank'); w.document.write('<!doctype html><meta charset="utf-8"><title>PDF</title>');
    w.document.write(document.querySelector('section.card:nth-of-type(3)').outerHTML);
    w.document.close(); w.focus(); w.print();
  };

  await renderMonth();
});
</script>
</body>
</html>
