<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zeiterfassung V59</title>
<link rel="manifest" href="/Zeiterfassung/manifest.json">
<link rel="icon" href="/Zeiterfassung/assets/logo.png">
<style>body{font-family:sans-serif;margin:0;background:#faf6f6;color:#222} header{background:#d9c9b9;padding:10px;display:flex;justify-content:space-between} header a{text-decoration:none;color:#222} .wrap{max-width:1000px;margin:0 auto;padding:10px} .card{background:#fff;margin:10px 0;padding:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)} button{padding:6px 12px;margin:4px}</style>
</head>
<body>
<header><strong>Zeiterfassung – V59</strong><nav><a href="/Zeiterfassung/users/">Mitarbeiterverwaltung</a> | <a href="#" id="logout">Logout</a></nav></header>
<main class="wrap">
<section class="card">
  <h2>Zeiteingabe</h2>
  <label>Projekt</label><select id="projectSelect"></select>
  <label>Pausen (Minuten)</label><input id="pauseMin" type="number" value="30">
  <label>Bemerkung</label><input id="note">
  <label>Status</label><select id="status"><option value="work">Arbeit</option><option value="urlaub">Urlaub</option><option value="krank">Krank</option></select>
  <label>Start</label><input type="time" id="startT" value="08:00">
  <label>Ende</label><input type="time" id="endT" value="17:00">
  <label>Datum</label><input type="date" id="date">
  <div id="userSelectWrap"></div>
  <button id="btnSaveMine">Nur für mich speichern</button>
  <button id="btnSaveAll">Für alle ausgewählten speichern</button>
</section>
<section class="card">
  <h3>Übersicht Monat</h3>
  <label>Monat</label><input type="month" id="monthPicker">
  <label>Nutzer</label><select id="userPicker"></select>
  <table border="1" width="100%"><thead><tr><th>Datum</th><th>Status</th><th>Von</th><th>Bis</th><th>Projekt</th><th>Pause</th><th>Arbeitszeit</th></tr></thead><tbody id="tblMonth"></tbody><tfoot><tr><td colspan="6">Summe</td><td id="sumTime">00:00</td></tr></tfoot></table>
</section>
</main>
<script>
const DB_NAME='zeit-web-pwa2-v59';
const STORE={users:'users',projects:'projects',entries:'entries'};
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains('users'))db.createObjectStore('users',{keyPath:'username'});if(!db.objectStoreNames.contains('projects'))db.createObjectStore('projects',{keyPath:'id'});if(!db.objectStoreNames.contains('entries'))db.createObjectStore('entries',{keyPath:'id'});};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
const os=(db,n,m='readonly')=>db.transaction(n,m).objectStore(n);
const pad=n=>String(n).padStart(2,'0');
const minToHHMM=m=>pad(Math.floor(m/60))+':'+pad(m%60);
const today=()=>new Date().toISOString().slice(0,10);
async function bootstrap(){const db=await openDB();const us=os(db,'users');const cnt=await new Promise(r=>{const q=us.count();q.onsuccess=()=>r(q.result);});if(cnt===0)await new Promise(r=>{os(db,'users','readwrite').put({username:'admin',pass:'admin',role:'admin'}).onsuccess=()=>r();});if(!localStorage.getItem('cu2'))localStorage.setItem('cu2',JSON.stringify({username:'admin',role:'admin'}));document.getElementById('date').value=today();document.getElementById('monthPicker').value=today().slice(0,7);}
async function saveEntryFor(u){const date=document.getElementById('date').value;const pid=document.getElementById('projectSelect').value;const status=document.getElementById('status').value;const st=document.getElementById('startT').value;const en=document.getElementById('endT').value;const pause=+document.getElementById('pauseMin').value;const sm=+st.split(':')[0]*60+ +st.split(':')[1];const em=+en.split(':')[0]*60+ +en.split(':')[1];const work=Math.max(0,em-sm-pause);const db=await openDB();await new Promise(r=>{os(db,'entries','readwrite').put({id:crypto.randomUUID(),username:u,date,projectId:pid,status,start:sm,end:em,pause,work,month:date.slice(0,7)}).onsuccess=()=>r();});await renderMonth();}
async function getEntries(month,u){const db=await openDB();const s=os(db,'entries');const out=[];await new Promise(r=>{const q=s.openCursor();q.onsuccess=e=>{const c=e.target.result;if(c){const v=c.value;if(v.username===u&&v.month===month)out.push(v);c.continue();}else r();};});return out.sort((a,b)=>a.date.localeCompare(b.date));}
async function renderMonth(){const m=document.getElementById('monthPicker').value;const u=document.getElementById('userPicker').value;const rows=await getEntries(m,u);const tb=document.getElementById('tblMonth');tb.innerHTML='';let sum=0;for(const r of rows){sum+=r.work;const tr=document.createElement('tr');tr.innerHTML='<td>'+r.date+'</td><td>'+r.status+'</td><td>'+minToHHMM(r.start)+'</td><td>'+minToHHMM(r.end)+'</td><td>'+r.projectId+'</td><td>'+r.pause+'</td><td>'+minToHHMM(r.work)+'</td>';tb.appendChild(tr);}document.getElementById('sumTime').textContent=minToHHMM(sum);}
window.addEventListener('DOMContentLoaded',async()=>{await bootstrap();document.getElementById('btnSaveMine').onclick=()=>saveEntryFor('admin');document.getElementById('btnSaveAll').onclick=()=>saveEntryFor('admin');await renderMonth();});
</script></body></html>
