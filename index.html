<!doctype html><html lang="de"><head><title>Mitarbeiterverwaltung</title>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="manifest" href="../manifest.json"><link rel="icon" href="../icons/icon-192.png">
<style>:root{--bg:#faf8f6;--card:#fff;--ink:#2b261f;--primary:#c9b8a6;--button:#8c7b6a;--line:#e5e7eb}*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}header{background:var(--primary);color:#2b261f;padding:10px 14px;display:flex;justify-content:space-between;align-items:center}.brand{display:flex;gap:10px;align-items:center}.brand img{height:34px}main{max-width:1100px;margin:0 auto;padding:16px}.card{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin:12px 0}input,select,button{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit}button{background:var(--button);color:#fff;cursor:pointer}button.ghost{background:#fff;color:#2b261f;border:1px solid #d1d5db}.row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1 1 220px}</style>
</head><body>
<header><div class="brand"><img src="../assets/logo.png" alt="Logo"><strong>Zeiterfassung</strong></div><div class="row" style="flex:0 0 auto;gap:8px;align-items:center"><a href="../" class="ghost" style="text-decoration:none;display:inline-block;width:auto">&larr; Zurueck</a></div></header>
<main>
<section class="card" id="guard" style="display:none"><p>Kein Zugriff - bitte als Admin anmelden.</p><p><a href="../" class="ghost" style="text-decoration:none;display:inline-block;width:auto">Zur Login-Seite</a></p></section>
<section class="card" id="createBox"><h2>Neuen Mitarbeiter anlegen</h2><div class="row"><div><label>Benutzername<input id="nuUser"></label></div><div><label>Anzeigename<input id="nuDisplay"></label></div><div><label>Passwort<input id="nuPass" type="password"></label></div><div><label>Rolle<select id="nuRole"><option value="worker">Mitarbeiter</option><option value="admin">Admin</option></select></label></div><div style="align-self:end"><button id="btnCreateUser">Anlegen</button></div></div></section>
<section class="card" id="listBox"><h2>Nutzerliste</h2><table style="width:100%;border-collapse:collapse"><thead><tr><th>Benutzername</th><th>Anzeigename</th><th>Rolle</th><th>Status</th><th>Aktion</th></tr></thead><tbody id="userBody"></tbody></table></section>
</main>
<script>
if (location.protocol.startsWith('http')) { navigator.serviceWorker && navigator.serviceWorker.register('../sw.js'); }
const DB_NAME='zeit-web-pwa', DB_VERSION=1; const STORE={ users:'users', projects:'projects', entries:'entries' };
function withDB(){return new Promise(function(resolve,reject){var r=indexedDB.open(DB_NAME,DB_VERSION); r.onupgradeneeded=function(){var db=r.result; if(!db.objectStoreNames.contains(STORE.users)) db.createObjectStore(STORE.users,{keyPath:'username'}); if(!db.objectStoreNames.contains(STORE.projects)) db.createObjectStore(STORE.projects,{keyPath:'id'}); if(!db.objectStoreNames.contains(STORE.entries)) db.createObjectStore(STORE.entries,{keyPath:'id'});}; r.onsuccess=function(){resolve(r.result)}; r.onerror=function(){reject(r.error)}; }); }
async function put(store,val){var db=await withDB();return new Promise(function(res,rej){var tx=db.transaction(store,'readwrite');tx.objectStore(store).put(val);tx.oncomplete=function(){res(val)};tx.onerror=function(){rej(tx.error)};});}
async function get(store,key){var db=await withDB();return new Promise(function(res,rej){var tx=db.transaction(store,'readonly');var q=tx.objectStore(store).get(key);q.onsuccess=function(){res(q.result)};q.onerror=function(){rej(q.error)};});}
async function getAll(store){var db=await withDB();return new Promise(function(res,rej){var tx=db.transaction(store,'readonly');var q=tx.objectStore(store).getAll();q.onsuccess=function(){res(q.result)};q.onerror=function(){rej(q.error)};});}
async function delRec(store,key){var db=await withDB();return new Promise(function(res,rej){var tx=db.transaction(store,'readwrite');tx.objectStore(store).delete(key);tx.oncomplete=function(){res(true)};tx.onerror=function(){rej(tx.error)};});}
function me(){ try{return JSON.parse(localStorage.getItem('cu')||'null');}catch(e){return null;} }
function showGuard(show){ document.getElementById('guard').style.display = show?'block':'none'; document.getElementById('createBox').style.display = show?'none':'block'; document.getElementById('listBox').style.display = show?'none':'block'; }
async function renderUsers(){ var tbody=document.getElementById('userBody'); tbody.innerHTML=''; var users=await getAll(STORE.users); var adminCount=users.filter(function(u){return u.role==='admin' && u.active!==false;}).length; for(var i=0;i<users.length;i++){ var u=users[i]; var tr=document.createElement('tr'); var tdU=document.createElement('td'); tdU.textContent=u.username; var tdD=document.createElement('td'); var inD=document.createElement('input'); inD.value=u.display||''; inD.style.width='100%'; tdD.appendChild(inD); var tdR=document.createElement('td'); var selR=document.createElement('select'); ['worker','admin'].forEach(function(r){ var o=document.createElement('option'); o.value=r; o.textContent=(r==='admin'?'Admin':'Mitarbeiter'); if(u.role===r)o.selected=true; selR.appendChild(o); }); tdR.appendChild(selR); var tdS=document.createElement('td'); var s=document.createElement('span'); s.textContent=(u.active===false?'Inaktiv':'Aktiv'); tdS.appendChild(s); var tdA=document.createElement('td'); var bSave=document.createElement('button'); bSave.textContent='Speichern'; bSave.onclick=async function(uRef,inRef,selRef){ return async function(){ await put(STORE.users,Object.assign({},uRef,{ display:inRef.value.trim(), role:selRef.value })); await renderUsers(); }; }(u,inD,selR); var bPwd=document.createElement('button'); bPwd.className='ghost'; bPwd.textContent='Passwort'; bPwd.onclick=async function(uRef){ return async function(){ var np=prompt('Neues Passwort fuer '+uRef.username+':'); if(!np) return; await put(STORE.users,Object.assign({},uRef,{password:np})); alert('Passwort aktualisiert'); }; }(u); var bToggle=document.createElement('button'); bToggle.className='ghost'; bToggle.textContent=(u.active===false?'Aktivieren':'Deaktivieren'); bToggle.onclick=async function(uRef){ return async function(){ if(uRef.role==='admin' && uRef.active!==false && adminCount<=1){ alert('Letzter aktiver Admin – kann nicht deaktiviert werden.'); return; } await put(STORE.users,Object.assign({},uRef,{ active: !(uRef.active===false) })); await renderUsers(); }; }(u); var bDel=document.createElement('button'); bDel.className='ghost'; bDel.textContent='Loeschen'; bDel.onclick=async function(uRef){ return async function(){ if(uRef.role==='admin' && uRef.active!==false && adminCount<=1){ alert('Letzter aktiver Admin – kann nicht geloescht werden.'); return; } if(!confirm('Nutzer loeschen?')) return; await delRec(STORE.users,uRef.username); await renderUsers(); }; }(u); tdA.appendChild(bSave); tdA.appendChild(bPwd); tdA.appendChild(bToggle); tdA.appendChild(bDel); tr.appendChild(tdU); tr.appendChild(tdD); tr.appendChild(tdR); tr.appendChild(tdS); tr.appendChild(tdA); tbody.appendChild(tr); } }
window.addEventListener('DOMContentLoaded', async function(){ var u=me(); if(!u || u.role!=='admin'){ showGuard(true); return; } showGuard(false); document.getElementById('btnCreateUser').onclick=async function(){ var nu=document.getElementById('nuUser').value.trim(); var nd=document.getElementById('nuDisplay').value.trim(); var np=document.getElementById('nuPass').value; var nr=document.getElementById('nuRole').value; if(!nu || !np) return alert('Benutzername und Passwort sind Pflicht.'); var exists=await get(STORE.users, nu); if(exists) return alert('Benutzername existiert bereits.'); await put(STORE.users, {username:nu, display:(nd||nu), password:np, role:nr, active:true}); document.getElementById('nuUser').value=''; document.getElementById('nuDisplay').value=''; document.getElementById('nuPass').value=''; document.getElementById('nuRole').value='worker'; await renderUsers(); }; await renderUsers(); });
</script>
</body></html>
