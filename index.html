<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zeiterfassung – V60</title>
<link rel="manifest" href="/Zeiterfassung/manifest.json">
<link rel="icon" href="/Zeiterfassung/assets/logo.png">
<style>
:root{--bg:#faf6f6;--ink:#1e1e1e;--brand:#2b261f;--line:#ddd;--card:#fff;--btn:#8c7b6a}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
header{background:#d9c9b9;color:var(--brand);padding:10px 14px;display:flex;gap:12px;align-items:center;justify-content:space-between}
header a{color:var(--brand);text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.card{background:var(--card);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
label{display:block;font-size:12px;margin:6px 0 3px;color:#555}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit}
.row{display:grid;gap:12px}.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:820px){.row-2,.row-3{grid-template-columns:1fr}}
button{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:10px 16px;font:inherit;cursor:pointer}
button.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--line);text-align:left;padding:10px;font-size:14px}
.muted{color:#777}
.badge{background:#fff;border:1px solid var(--line);padding:4px 8px;border-radius:999px}
</style>
</head>
<body>
<header>
  <strong>Zeiterfassung – V60</strong>
  <nav style="display:flex;gap:12px;align-items:center">
    <a href="/Zeiterfassung/users/">Mitarbeiterverwaltung</a>
    <span id="userBadge" class="badge"></span>
    <a href="#" id="logout">Logout</a>
  </nav>
</header>

<section id="loginPane" class="wrap" style="display:none">
  <div class="card" style="max-width:420px">
    <h3>Anmelden</h3>
    <label>Benutzername</label>
    <input id="lgUser" autocomplete="username" placeholder="z. B. admin">
    <label>Passwort</label>
    <input id="lgPass" type="password" autocomplete="current-password" placeholder="z. B. admin">
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="btnLogin">Login</button>
      <button class="ghost" id="btnLoginCancel">Abbrechen</button>
    </div>
    <p class="muted" style="margin-top:6px">Erststart? Standardnutzer ist <code>admin</code> / <code>admin</code>.</p>
  </div>
</section>

<main class="wrap" id="appPane" style="display:none">
  <section class="card">
    <h2>Zeiteingabe</h2>
    <div class="row row-3">
      <div><label>Projekt / Kostenstelle</label><select id="projectSelect"></select></div>
      <div><label>Pausen (Minuten)</label><input id="pauseMin" type="number" value="30"></div>
      <div><label>Bemerkung</label><input id="note" placeholder="z. B. Montage, Fahrtzeit"></div>
    </div>
    <div class="row row-3">
      <div><label>Status</label><select id="status"><option value="work">Arbeit</option><option value="urlaub">Urlaub</option><option value="krank">Krank</option></select></div>
      <div><label>Start</label><input type="time" id="startT" value="08:00"></div>
      <div><label>Ende</label><input type="time" id="endT" value="17:00"></div>
    </div>
    <div class="row row-2">
      <div><label>Datum</label><input type="date" id="date"></div>
      <div>
        <label>Mitarbeiter auswählen</label>
        <div id="userChecks" class="muted">Admins/Teamleiter sehen alle Nutzer, Mitarbeiter nur sich selbst.</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="btnSaveMine">Nur für mich speichern</button>
      <button id="btnSaveAll">Für alle ausgewählten speichern</button>
    </div>
  </section>

  <section class="card">
    <h3>Übersicht Monat</h3>
    <div class="row row-2">
      <div><label>Monat</label><input type="month" id="monthPicker"></div>
      <div><label>Nutzer</label><select id="userPicker"></select></div>
    </div>
    <table>
      <thead><tr><th>Datum</th><th>Status</th><th>Von</th><th>Bis</th><th>Projekt</th><th>Pause</th><th>Arbeitszeit</th></tr></thead>
      <tbody id="tblMonth"></tbody>
      <tfoot><tr><td colspan="6">Summe</td><td id="sumTime">00:00</td></tr></tfoot>
    </table>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="ghost" id="btnCsv">CSV‑Export</button>
    </div>
  </section>
</main>

<script>
const DB_NAME='zeit-web-v60';
const STORE={users:'users',projects:'projects',entries:'entries'};
const CU_KEY='cu2';

function openDB(){
  return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1);
    r.onupgradeneeded=e=>{const db=e.target.result;
      if(!db.objectStoreNames.contains('users')) db.createObjectStore('users',{keyPath:'username'});
      if(!db.objectStoreNames.contains('projects')) db.createObjectStore('projects',{keyPath:'id'});
      if(!db.objectStoreNames.contains('entries')) db.createObjectStore('entries',{keyPath:'id'});
    };
    r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
  });
}
const os=(db,n,m='readonly')=>db.transaction(n,m).objectStore(n);
const pad=n=>String(n).padStart(2,'0');
const minToHHMM=m=>pad(Math.floor(m/60))+':'+pad(m%60);
const today=()=>new Date().toISOString().slice(0,10);
const ym=()=>new Date().toISOString().slice(0,7);

function me(){try{return JSON.parse(localStorage.getItem(CU_KEY)||'null');}catch{return null;}}
function setMe(u){localStorage.setItem(CU_KEY,JSON.stringify(u));}
function clearMe(){localStorage.removeItem(CU_KEY);}

function showAppUI(flag){document.getElementById('appPane').style.display=flag?'':'none'; document.getElementById('loginPane').style.display=flag?'none':'';}

async function ensureSeed(){
  const db=await openDB();
  const su=os(db,'users'); const pc=os(db,'projects');
  const ucount=await new Promise(r=>{const q=su.count(); q.onsuccess=()=>r(q.result);});
  if(ucount===0){ await new Promise(r=>{os(db,'users','readwrite').put({username:'admin',pass:'admin',role:'admin',display:'Administrator',status:'active'}).onsuccess=()=>r();}); }
  const pcount=await new Promise(r=>{const q=pc.count(); q.onsuccess=()=>r(q.result);});
  if(pcount===0){ await new Promise(r=>{os(db,'projects','readwrite').put({id:'allgemein',name:'Allgemein'}).onsuccess=()=>r();}); }
}

async function login(u,p){
  const db=await openDB(); const s=os(db,'users'); const rec=await new Promise(r=>{const q=s.get(u); q.onsuccess=()=>r(q.result||null);});
  if(!rec||rec.pass!==p||rec.status==='inactive') throw new Error('Login fehlgeschlagen');
  setMe({username:rec.username,role:rec.role,display:rec.display||rec.username});
  return me();
}
function logout(){ clearMe(); caches?.keys?.().then(keys=>Promise.all(keys.map(k=>caches.delete(k)))).finally(()=>location.reload()); }

async function loadProjects(){
  const db=await openDB(); const s=os(db,'projects'); const out=[];
  await new Promise(r=>{const c=s.openCursor(); c.onsuccess=e=>{const cur=e.target.result; if(cur){out.push(cur.value); cur.continue();} else r();};});
  out.sort((a,b)=>a.name.localeCompare(b.name));
  const sel=document.getElementById('projectSelect'); sel.innerHTML='';
  for(const p of out){ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); }
}

async function loadUsersForSelection(){
  const db=await openDB(); const s=os(db,'users'); const rows=[];
  await new Promise(r=>{const c=s.openCursor(); c.onsuccess=e=>{const cur=e.target.result; if(cur){rows.push(cur.value); cur.continue();} else r();};});
  rows.sort((a,b)=>a.username.localeCompare(b.username));
  const u=me(); const wrap=document.getElementById('userChecks'); wrap.innerHTML='';
  const isAdmin=u&& (u.role==='admin'||u.role==='teamleiter');
  const list=isAdmin?rows.filter(x=>x.status!=='inactive'):rows.filter(x=>x.username===u.username && x.status!=='inactive');
  for(const x of list){
    const id='u_'+x.username;
    const lab=document.createElement('label'); lab.style.display='inline-flex'; lab.style.alignItems='center'; lab.style.gap='8px'; lab.style.marginRight='12px';
    lab.innerHTML='<input type="checkbox" data-u="'+x.username+'"> '+(x.display||x.username);
    wrap.appendChild(lab);
  }
  const mine=wrap.querySelector('[data-u="'+u.username+'"]'); if(mine) mine.checked=true;
}

async function getEntries(month,u){
  const db=await openDB(); const s=os(db,'entries'); const out=[];
  await new Promise(r=>{const c=s.openCursor(); c.onsuccess=e=>{const cur=e.target.result; if(cur){const v=cur.value; if(v.username===u && v.month===month) out.push(v); cur.continue();} else r();};});
  return out.sort((a,b)=>a.date.localeCompare(b.date));
}

async function saveEntryFor(username){
  const date=document.getElementById('date').value;
  const pid=document.getElementById('projectSelect').value;
  const status=document.getElementById('status').value;
  const st=document.getElementById('startT').value;
  const en=document.getElementById('endT').value;
  const pause=+document.getElementById('pauseMin').value||0;
  const sm=+st.split(':')[0]*60+ +st.split(':')[1];
  const em=+en.split(':')[0]*60+ +en.split(':')[1];
  const work=Math.max(0,em-sm-pause);
  const rec={id:crypto.randomUUID(),username,date,projectId:pid,status,start:sm,end:em,pause,work,month:date.slice(0,7),note:document.getElementById('note').value};
  const db=await openDB(); await new Promise(r=>{os(db,'entries','readwrite').add(rec).onsuccess=()=>r();});
  await renderMonth();
}

async function renderMonth(){
  const m=document.getElementById('monthPicker').value;
  const u=document.getElementById('userPicker').value;
  const rows=await getEntries(m,u);
  const tb=document.getElementById('tblMonth'); tb.innerHTML=''; let sum=0;
  for(const r of rows){
    sum+=r.work; const tr=document.createElement('tr');
    tr.innerHTML='<td>'+r.date+'</td><td>'+r.status+'</td><td>'+minToHHMM(r.start)+'</td><td>'+minToHHMM(r.end)+'</td><td>'+r.projectId+'</td><td>'+r.pause+'</td><td>'+minToHHMM(r.work)+'</td>';
    tb.appendChild(tr);
  }
  document.getElementById('sumTime').textContent=minToHHMM(sum);
}

async function fillUserPicker(){
  const db=await openDB(); const s=os(db,'users'); const rows=[];
  await new Promise(r=>{const c=s.openCursor(); c.onsuccess=e=>{const cur=e.target.result; if(cur){rows.push(cur.value); cur.continue();} else r();};});
  rows.sort((a,b)=>a.username.localeCompare(b.username));
  const sel=document.getElementById('userPicker'); sel.innerHTML='';
  for(const x of rows){ if(x.status==='inactive') continue; const o=document.createElement('option'); o.value=x.username; o.textContent=x.display||x.username; sel.appendChild(o); }
  const u=me(); if(u) sel.value=u.username;
}

async function bootstrapAfterLogin(){
  const u=me(); document.getElementById('userBadge').textContent=u? (u.display||u.username)+' ('+u.role+')' : '';
  await loadProjects(); await loadUsersForSelection();
  document.getElementById('date').value=today(); document.getElementById('monthPicker').value=ym();
  await fillUserPicker(); await renderMonth();
}

window.addEventListener('DOMContentLoaded', async ()=>{
  await ensureSeed();
  document.getElementById('logout').onclick=(e)=>{e.preventDefault(); logout();};
  document.getElementById('btnLogin').onclick=async()=>{try{await login(document.getElementById('lgUser').value.trim(), document.getElementById('lgPass').value); showAppUI(true); await bootstrapAfterLogin();}catch(err){alert(err.message||'Login fehlgeschlagen');}};
  document.getElementById('btnLoginCancel').onclick=()=>{ document.getElementById('lgPass').value=''; };
  document.getElementById('btnSaveMine').onclick=async()=>{await saveEntryFor(me().username);};
  document.getElementById('btnSaveAll').onclick=async()=>{const boxes=[...document.querySelectorAll('#userChecks input[type=checkbox]:checked')]; for(const b of boxes) await saveEntryFor(b.dataset.u);};
  document.getElementById('monthPicker').addEventListener('change', renderMonth);
  document.getElementById('userPicker').addEventListener('change', renderMonth);

  if(me()){ showAppUI(true); await bootstrapAfterLogin(); } else { showAppUI(false); }
});

if('serviceWorker' in navigator) navigator.serviceWorker.register('/Zeiterfassung/sw.js');
</script>
</body></html>
