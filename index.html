<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zeiterfassung</title>
<link rel="manifest" href="/Zeiterfassung/manifest.json">
<link rel="icon" href="/Zeiterfassung/assets/logo.png">
<style>:root{--bg:#faf6f6;--ink:#1d1d1d;--card:#fff;--line:#ddd;--btn:#8c7b6a;--brand:#2b261f;--mut:#666}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
header{background:#d9c9b9;color:var(--brand);padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
header a{color:var(--brand);text-decoration:none}
.wrap{max-width:1080px;margin:16px auto;padding:0 12px}
.card{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin:12px 0}
label{display:block;font-size:12px;margin-bottom:4px;color:#555}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit}
textarea{resize:vertical;min-height:40px}
button{background:var(--btn);color:#fff;border:0;padding:10px 16px;border-radius:12px;font:inherit;cursor:pointer}
button.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
.row{display:grid;gap:12px}
.row-2{grid-template-columns:1fr 1fr}
.row-3{grid-template-columns:1fr 1fr 1fr}
.row-inline{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:end}
@media(max-width:820px){.row-2,.row-3,.row-inline{grid-template-columns:1fr}}
.range-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border-bottom:1px solid var(--line);text-align:left;padding:10px;font-size:14px}
th{font-weight:600}
.muted{color:var(--mut)}
#photoGallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-top:10px}
#photoGallery figure{margin:0;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
#photoGallery img{display:block;width:100%;height:110px;object-fit:cover}
#photoGallery figcaption{font-size:12px;color:#666;text-align:center;padding:6px}
</style>
</head>
<body>
<header>
  <strong>Zeiterfassung – Clean V54</strong>
  <nav><a href="/Zeiterfassung/users/">Mitarbeiterverwaltung</a></nav>
</header>

<main class="wrap">
  <section class="card">
    <h2>Zeiteingabe</h2>
    <div class="row row-3">
      <div>
        <label>Projekt / Kostenstelle</label>
        <select id="projectSelect"></select>
      </div>
      <div>
        <label>Pausen (Minuten)</label>
        <select id="pauseMin"><option>0</option><option>15</option><option selected>30</option><option>45</option><option>60</option></select>
      </div>
      <div><label>Bemerkung</label><input id="note" placeholder="z. B. Montage, Fahrzeit"></div>
    </div>
    <div class="row row-2">
      <div><label>Tagesstatus</label>
        <select id="status"><option value="work" selected>Arbeit</option><option value="urlaub">Urlaub</option><option value="krank">Krank</option></select>
      </div>
      <div></div>
    </div>
    <div class="range-row" style="margin-top:6px">
      <div>
        <div class="range-row"><input id="startRange" type="range" min="0" max="1439" value="480"><span>Start</span></div>
        <div class="range-row" style="margin-top:8px"><input id="endRange" type="range" min="0" max="1439" value="1020"><span>Ende</span></div>
      </div>
      <div><label>Arbeitszeit (HH:MM)</label><input id="workTime" type="text" readonly></div>
    </div>
    <div class="row row-2" style="margin-top:8px">
      <div><label>Datum</label><input id="date" type="date"></div><div></div>
    </div>
    <div class="card" style="padding:12px;margin:14px 0">
      <h3>Mitarbeiter auswählen</h3>
      <label style="display:flex;gap:10px;align-items:center"><input type="checkbox" id="chkMe" checked> <span id="meLabel">Ich (Admin)</span></label>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px"><button id="btnSaveMine">Nur für mich speichern</button></div>
    </div>
  </section>

  <section id="photoWrap" class="card">
    <h3>Fotos zum Eintrag / Projekt</h3>
    <div class="row row-2" style="grid-template-columns:1fr auto">
      <input id="photoInput" type="file" accept="image/*" multiple capture="environment">
      <button id="btnAddPhotos" class="ghost">Fotos hinzufügen</button>
    </div>
    <div id="photoGallery"></div>
  </section>

  <section class="card">
    <h3>Übersicht Monat</h3>
    <div class="row row-3">
      <div><label>Monat</label><input id="monthPicker" type="month"></div>
      <div><label>Nutzer</label><select id="userPicker"></select></div>
      <div></div>
    </div>
    <table><thead><tr><th>Datum</th><th>Status</th><th>Von</th><th>Bis</th><th>Projekt</th><th>Pausen</th><th>Arbeitszeit</th><th>Aktion</th></tr></thead>
      <tbody id="tblMonth"></tbody><tfoot><tr><td colspan="6">Summe</td><td id="sumTime">00:00</td><td></td></tr></tfoot></table>
    <div style="display:flex;gap:10px;margin-top:10px"><button id="btnCsv" class="ghost">CSV-Export</button><button id="btnPdf" class="ghost">PDF-Export</button></div>
  </section>

  <section class="card">
    <h3>Projekte (Admin)</h3>
    <div class="row row-2" style="grid-template-columns:1fr auto">
      <input id="newProjectName" placeholder="Projektname / Kostenstelle">
      <button id="btnAddProject" class="ghost">Anlegen</button>
    </div>
    <ul id="projectList"></ul>
  </section>
</main>

<script>
const APP_SCOPE='/Zeiterfassung/';
const DB_NAME='zeit-web-pwa2';
const CACHE_KEEP='zeit2-pwa-v54';
async function autoCleanup(){
  try{
    if(indexedDB.databases){
      const dbs=await indexedDB.databases();
      for(const d of dbs){
        const name=d.name||'';
        if(name && name!==DB_NAME && (name.startsWith('zeit')||name.includes('pwa'))){
          try{indexedDB.deleteDatabase(name);}catch(e){}
        }
      }
    }
    const legacy=['zeit-web-pwa','zeit-web','zeit-pwa','zeit-pwa-v29','zeit-pwa-v30','zeit-pwa-v31','zeit-pwa-v32','zeit-pwa-v33','zeit-pwa-v34','zeit-pwa-v35','zeit-pwa-v36','zeit-pwa-v37','zeit-pwa-v38','zeit-pwa-v39','zeit-pwa-v40','zeit-pwa-v41','zeit-pwa-v42','zeit-pwa-v43'];
    legacy.forEach(n=>{try{indexedDB.deleteDatabase(n);}catch(e){}});
  }catch(e){}
  try{
    const keys=await caches.keys();
    await Promise.all(keys.filter(k=>k!==CACHE_KEEP).map(k=>caches.delete(k)));
  }catch(e){}
  try{
    if(navigator.serviceWorker){
      const regs=await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.filter(r=>r.scope && r.scope.endsWith(APP_SCOPE)).map(r=>r.unregister()));
    }
  }catch(e){}
}

const STORE={ users:'users', projects:'projects', entries:'entries', photos:'photos' };
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onerror=()=>reject(req.error);
    req.onsuccess=()=>resolve(req.result);
    req.onupgradeneeded=ev=>{
      const db=ev.target.result;
      if(!db.objectStoreNames.contains(STORE.users)){ const s=db.createObjectStore(STORE.users,{keyPath:'username'}); s.createIndex('role','role',{unique:false}); }
      if(!db.objectStoreNames.contains(STORE.projects)){ const s=db.createObjectStore(STORE.projects,{keyPath:'id'}); s.createIndex('name','name',{unique:false}); }
      if(!db.objectStoreNames.contains(STORE.entries)){ const s=db.createObjectStore(STORE.entries,{keyPath:'id'}); s.createIndex('byUser','username',{unique:false}); s.createIndex('byMonth','month',{unique:false}); }
      if(!db.objectStoreNames.contains(STORE.photos)){ const s=db.createObjectStore(STORE.photos,{keyPath:'id'}); s.createIndex('byProject','projectId',{unique:false}); }
    };
  });
}
const os=(db,name,mode='readonly')=>db.transaction(name,mode).objectStore(name);
const me=()=>{ try{return JSON.parse(localStorage.getItem('cu2')||'null');}catch(_){return null;} };
const setMe=u=>localStorage.setItem('cu2',JSON.stringify(u));
const pad=n=>String(n).padStart(2,'0');
const minToHHMM=m=>pad(Math.floor(m/60))+':'+pad(m%60);
const today=()=>new Date().toISOString().slice(0,10);
const monthKey=d=>d.slice(0,7);

async function bootstrap(){
  const db=await openDB();
  const ustore=os(db,STORE.users);
  const count=await new Promise((res,rej)=>{const r=ustore.count(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});
  if(count===0){
    await new Promise((res,rej)=>{const r=os(db,STORE.users,'readwrite').put({username:'admin',display:'Administrator',pass:'admin',role:'admin',status:'active'}); r.onsuccess=res; r.onerror=()=>rej(r.error);});
    await new Promise((res,rej)=>{const r=os(db,STORE.projects,'readwrite').put({id:crypto.randomUUID(),name:'Allgemein'}); r.onsuccess=res; r.onerror=()=>rej(r.error);});
  }
  if(!me()) setMe({username:'admin',display:'Administrator',role:'admin'});
  document.getElementById('meLabel').textContent=(me().display||me().username)+' ('+me().role+')';
}
async function listProjects(){
  const db=await openDB(); const st=os(db,STORE.projects); const items=[];
  await new Promise((res,rej)=>{const r=st.openCursor(); r.onsuccess=e=>{const c=e.target.result; if(c){items.push(c.value); c.continue();} else res();}; r.onerror=()=>rej(r.error);});
  items.sort((a,b)=>a.name.localeCompare(b.name));
  const sel=document.getElementById('projectSelect'); sel.innerHTML=''; for(const p of items){ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); }
  const ul=document.getElementById('projectList'); if(ul){ ul.innerHTML=''; for(const p of items){ const li=document.createElement('li'); li.textContent=p.name; ul.appendChild(li);} }
}
async function addProject(name){
  if(!name||!name.trim()) return;
  const db=await openDB();
  await new Promise((res,rej)=>{const r=os(db,STORE.projects,'readwrite').put({id:crypto.randomUUID(),name:name.trim()}); r.onsuccess=res; r.onerror=()=>rej(r.error);});
  await listProjects();
}
async function saveEntryFor(username){
  const date=document.getElementById('date').value;
  const pid=document.getElementById('projectSelect').value;
  const status=document.getElementById('status').value;
  const start=+document.getElementById('startRange').value;
  const end=+document.getElementById('endRange').value;
  const pause=+document.getElementById('pauseMin').value;
  const note=document.getElementById('note').value.trim();
  const work=Math.max(0,end-start-pause);
  const rec={id:crypto.randomUUID(),username,date,projectId:pid,status,start,end,pause,note,work,month:monthKey(date)};
  const db=await openDB(); await new Promise((res,rej)=>{const r=os(db,STORE.entries,'readwrite').put(rec); r.onsuccess=res; r.onerror=()=>rej(r.error);});
  await renderMonth(); alert('Gespeichert.');
}
async function getEntries(month,u){
  const db=await openDB(); const st=os(db,STORE.entries); const out=[];
  await new Promise((res,rej)=>{const r=st.openCursor(); r.onsuccess=e=>{const c=e.target.result; if(c){const v=c.value; if(v.username===u&&v.month===month) out.push(v); c.continue();} else res();}; r.onerror=()=>rej(r.error);});
  out.sort((a,b)=>a.date.localeCompare(b.date)); return out;
}
async function compressImage(file,maxW=1600,quality=.82){
  const img=new Image(); const dataUrl=await new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});
  img.src=dataUrl; await new Promise(res=>img.onload=res);
  const scale=Math.min(1,maxW/img.width),w=Math.round(img.width*scale),h=Math.round(img.height*scale);
  const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); return c.toDataURL('image/jpeg',quality);
}
async function addPhotosToProject(){
  const inp=document.getElementById('photoInput'); const files=Array.from(inp.files||[]);
  if(!files.length){alert('Bitte Fotos auswählen.'); return;}
  const pid=document.getElementById('projectSelect').value; if(!pid){alert('Bitte Projekt wählen.'); return;}
  const db=await openDB(); const s=os(db,STORE.photos,'readwrite');
  for(const f of files){ const dataUrl=await compressImage(f); const rec={id:crypto.randomUUID(),projectId:pid,filename:f.name,dataUrl,createdAt:new Date().toISOString()}; await new Promise((res,rej)=>{const r=s.put(rec); r.onsuccess=res; r.onerror=()=>rej(r.error);}); }
  await refreshPhotoGallery(); inp.value='';
}
async function delPhoto(id){ const db=await openDB(); await new Promise((res,rej)=>{const r=os(db,STORE.photos,'readwrite').delete(id); r.onsuccess=res; r.onerror=()=>rej(r.error);}); await refreshPhotoGallery(); }
async function refreshPhotoGallery(){
  const pid=document.getElementById('projectSelect').value; const wrap=document.getElementById('photoGallery'); wrap.innerHTML=''; if(!pid) return;
  const db=await openDB(); const s=os(db,STORE.photos); const idx=s.index('byProject'); const list=[];
  await new Promise((res,rej)=>{const r=idx.openCursor(IDBKeyRange.only(pid)); r.onsuccess=e=>{const c=e.target.result; if(c){list.push(c.value); c.continue();} else res();}; r.onerror=()=>rej(r.error);});
  list.sort((a,b)=>a.createdAt.localeCompare(b.createdAt));
  for(const p of list){ const fig=document.createElement('figure'); const img=new Image(); img.src=p.dataUrl; img.alt=p.filename; const cap=document.createElement('figcaption'); cap.textContent=p.filename; const btn=document.createElement('button'); btn.className='ghost'; btn.textContent='Löschen'; btn.onclick=()=>{ if(confirm('Foto löschen?')) delPhoto(p.id); }; fig.appendChild(img); fig.appendChild(cap); fig.appendChild(btn); wrap.appendChild(fig); }
}
async function renderMonth(){
  const m=document.getElementById('monthPicker').value||monthKey(today());
  const u=document.getElementById('userPicker').value||(me()&&me().username);
  const rows=await getEntries(m,u); const tb=document.getElementById('tblMonth'); tb.innerHTML=''; let sum=0;
  for(const r of rows){ sum+=r.work; const tr=document.createElement('tr'); tr.innerHTML='<td>'+r.date+'</td><td>'+r.status+'</td><td>'+minToHHMM(r.start)+'</td><td>'+minToHHMM(r.end)+'</td><td>'+(r.projectId||'')+'</td><td>'+r.pause+'</td><td>'+minToHHMM(r.work)+'</td><td></td>'; tb.appendChild(tr); }
  document.getElementById('sumTime').textContent=minToHHMM(sum);
}

window.addEventListener('DOMContentLoaded', async ()=>{
  await autoCleanup();
  if('serviceWorker' in navigator){ try{ await navigator.serviceWorker.register('/Zeiterfassung/sw.js',{scope:'/Zeiterfassung/'}); }catch(e){} }
  const dbInit=bootstrap();
  document.getElementById('date').value=today();
  document.getElementById('monthPicker').value=monthKey(today());
  await dbInit; await listProjects(); await refreshPhotoGallery();
  const db=await openDB(); const us=os(db,STORE.users); const items=[];
  await new Promise((res,rej)=>{const r=us.openCursor(); r.onsuccess=e=>{const c=e.target.result; if(c){items.push(c.value); c.continue();} else res();}; r.onerror=()=>rej(r.error);});
  items.sort((a,b)=>a.username.localeCompare(b.username));
  const up=document.getElementById('userPicker'); up.innerHTML=''; for(const u of items){ const o=document.createElement('option'); o.value=u.username; o.textContent=(u.display||u.username)+' ('+u.role+')'; if(me()&&u.username===me().username) o.selected=true; up.appendChild(o); }
  const recalc=()=>{ const start=+document.getElementById('startRange').value, end=+document.getElementById('endRange').value, pause=+document.getElementById('pauseMin').value; const work=Math.max(0,end-start-pause), over=Math.max(0,work-8*60); document.getElementById('workTime').value=minToHHMM(work)+' (Ü: '+minToHHMM(over)+')'; };
  ['startRange','endRange','pauseMin'].forEach(id=>document.getElementById(id).addEventListener('input',recalc)); recalc();
  document.getElementById('btnAddProject').onclick=()=>{const v=document.getElementById('newProjectName').value; addProject(v).then(()=>document.getElementById('newProjectName').value='');};
  document.getElementById('projectSelect').addEventListener('change',refreshPhotoGallery);
  document.getElementById('btnAddPhotos').onclick=(e)=>{e.preventDefault(); addPhotosToProject();};
  document.getElementById('btnSaveMine').onclick=()=>saveEntryFor(me().username);
  document.getElementById('monthPicker').addEventListener('change',renderMonth);
  document.getElementById('userPicker').addEventListener('change',renderMonth);
  document.getElementById('btnCsv').onclick=async()=>{ const rows=await getEntries(document.getElementById('monthPicker').value, document.getElementById('userPicker').value); const head='Datum;Status;Von;Bis;Projekt;Pause;Arbeitszeit\n'; const body=rows.map(r=>[r.date,r.status,minToHHMM(r.start),minToHHMM(r.end),r.projectId||'',r.pause,minToHHMM(r.work)].join(';')).join('\n'); const blob=new Blob([head+body],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='zeiten.csv'; a.click(); };
  document.getElementById('btnPdf').onclick=()=>{ const w=window.open('','_blank'); w.document.write('<!doctype html><meta charset="utf-8"><title>PDF</title>'); w.document.write(document.querySelector('section.card:nth-of-type(3)').outerHTML); w.document.close(); w.focus(); w.print(); };
  await renderMonth();
});
</script>
</body></html>
