<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Backup – Arbeitseinteilung & Zeiterfassung</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
<header class="topbar">
  <div class="brand"><span class="logo-dot"></span><span class="brand-text">Arbeitseinteilung und Zeiterfassung Holzbau Zaunschirm</span></div>
  <nav class="nav">
    <a href="dashboard.html">Übersicht</a>
    <a href="mitarbeiter.html" class="require-role-admin">Mitarbeiter</a>
    <a href="zeiterfassung.html">Zeiterfassung</a>
    <a href="plan.html">Wocheneinteilung</a>
    <a href="reports.html" class="require-role-admin">Berichte</a>
    <a href="backup.html" class="require-role-admin">Backup</a>
    <button id="logoutBtn" class="btn-ghost">Logout</button>
      <a href="cloud.html" class="require-role-admin">Cloud</a>
    </nav>
</header>
<main class="container">
  <section class="card">
    <h1>Backup & Sync</h1>
    <p>Mit dieser Funktion kannst du alle Daten (Mitarbeiter, Projekte, Zeiten, Wocheneinteilung) als <strong>JSON</strong> exportieren und auf einem anderen Gerät importieren.</p>
    <div class="row wrap">
      <button id="btnExport" class="btn-primary">Backup exportieren (.json)</button>
      <label class="btn">
        Backup importieren
        <input type="file" id="fileImport" accept="application/json" style="display:none">
      </label>
      <button id="btnReplace" class="btn">Importierte Daten übernehmen (Ersetzen)</button>
      <button id="btnMerge" class="btn">Importierte Daten zusammenführen</button>
    </div>
    <div id="importStatus" style="margin-top:10px; color:#2F3438"></div>
    <details style="margin-top:12px">
      <summary><strong>Hinweis</strong></summary>
      <ul>
        <li><em>Ersetzen</em> überschreibt vorhandene Daten vollständig.</li>
        <li><em>Zusammenführen</em> fügt Datensätze hinzu und ersetzt gleichlautende IDs.</li>
        <li>Am besten zuerst am PC <em>exportieren</em>, dann am Handy <em>importieren</em>.</li>
      </ul>
    </details>
  </section>
</main>
<footer class="footer"><small>© 2025 Holzbau Zaunschirm • Backup</small></footer>
<script defer src="js/storage.js?v=03a?v=02c"></script>
<script defer src="js/auth.js?v=03a?v=02c"></script>
<script defer src="js/app.js?v=03a?v=02c"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  protectPage(['admin']); renderNavByRole();
  const status = document.getElementById('importStatus');
  let imported = null;

  document.getElementById('btnExport').addEventListener('click', ()=>{
    const dump = {
      users: readUsers(),
      times: readTimes(),
      plan: readPlan(),
      projects: readProjects()
    };
    const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'zaunschirm-backup.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  const fileImport = document.getElementById('fileImport');
  fileImport.addEventListener('change', ()=>{
    const f = fileImport.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        imported = JSON.parse(r.result);
        status.textContent = 'Backup geladen. Du kannst jetzt „Ersetzen“ oder „Zusammenführen“ klicken.';
      }catch(e){
        status.textContent = 'Fehler beim Lesen der Datei: ' + e.message;
      }
    };
    r.readAsText(f);
  });

  document.getElementById('btnReplace').addEventListener('click', ()=>{
    if(!imported){ status.textContent='Bitte zuerst eine Backup-Datei wählen.'; return; }
    if(!confirm('Alle bestehenden Daten durch Backup ersetzen?')) return;
    writeUsers(imported.users||[]);
    writeTimes(imported.times||{});
    writePlan(imported.plan||{});
    writeProjects(imported.projects||[]);
    status.textContent='Daten wurden ersetzt. Bitte Seiten neu laden.';
  });

  function mergeObjects(target, source){
    const out = Object.assign({}, target);
    for(const k in source){
      if(typeof source[k]==='object' && source[k] && !Array.isArray(source[k])){
        out[k] = mergeObjects(out[k]||{}, source[k]);
      }else{
        out[k] = source[k];
      }
    }
    return out;
  }

  document.getElementById('btnMerge').addEventListener('click', ()=>{
    if(!imported){ status.textContent='Bitte zuerst eine Backup-Datei wählen.'; return; }
    // Merge users: replace by id
    const curUsers = readUsers(); const mapU = new Map(curUsers.map(u=>[u.id,u]));
    (imported.users||[]).forEach(u=> mapU.set(u.id,u));
    writeUsers(Array.from(mapU.values()));
    // Merge times/plan shallow by keys
    writeTimes( mergeObjects(readTimes(), imported.times||{}) );
    writePlan( mergeObjects(readPlan(), imported.plan||{}) );
    // Merge projects by id
    const curP = readProjects(); const mapP = new Map(curP.map(p=>[p.id,p]));
    (imported.projects||[]).forEach(p=> mapP.set(p.id,p));
    writeProjects(Array.from(mapP.values()));
    status.textContent='Daten wurden zusammengeführt. Bitte Seiten neu laden.';
  });
});
</script>
<script defer src="js/cloud.js?v=03a"></script>
</body>
</html>
