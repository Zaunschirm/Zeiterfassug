<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard • Zeiterfassung V32</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main style="max-width:980px;margin:20px auto;padding:16px;">
    <div id="welcome"></div>

    <section id="pwChange" style="display:none;">
      <h3>Passwort ändern (Erstlogin)</h3>
      <div class="row">
        <input id="oldpw" type="password" placeholder="Altes Passwort">
        <input id="newpw" type="password" placeholder="Neues Passwort">
        <button id="btnPwChange">Speichern</button>
      </div>
    </section>

    <section>
      <div class="row">
        <input id="month" value="2025-10">
        <input id="userId" placeholder="User-ID (optional)">
        <button id="btnLoad">Monat laden</button>
      </div>
      <table id="tbl">
        <thead><tr><th>Datum</th><th>Typ</th><th>Stunden</th><th>Notiz</th><th>Aktion</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h3>Eintrag hinzufügen</h3>
      <div class="row">
        <input id="dDate" value="2025-10-04">
        <select id="dType"><option>WORK</option><option>URLAUB</option><option>KRANK</option></select>
        <input id="dHours" type="number" step="0.25" value="8">
        <input id="dNote" placeholder="Notiz">
        <input id="dUserId" placeholder="für User-ID (optional)">
        <button id="btnAdd">Hinzufügen</button>
      </div>
    </section>

    <section id="adminTools" style="display:none;">
      <h3>Admin-Tools</h3>
      <div class="row">
        <input id="newName" placeholder="Name">
        <input id="newEmail" placeholder="E-Mail">
        <input id="newPw" placeholder="Passwort" value="pass123">
        <select id="newRole"><option>MITARBEITER</option><option>TEAMLEITER</option><option>ADMIN</option></select>
        <input id="newTeam" placeholder="Team-ID (optional)">
        <button id="btnCreateUser">User anlegen</button>
      </div>
      <div class="row">
        <input id="roleUserId" placeholder="User-ID">
        <select id="roleRole"><option>MITARBEITER</option><option>TEAMLEITER</option><option>ADMIN</option></select>
        <input id="roleTeam" placeholder="Team-ID (optional)">
        <button id="btnSetRole">Rolle setzen</button>
      </div>
      <div class="row">
        <input id="impUserId" placeholder="User-ID für Impersonate">
        <button id="btnImpersonate">Als Benutzer anmelden</button>
      </div>
    </section>
  </main>
  <script>
    let ME = null;
    async function guard(){
      const r = await fetch('/api/guard');
      if (r.status === 401) { location.href='/login.html'; return; }
      const j = await r.json();
      ME = j.user;
      document.getElementById('welcome').innerHTML = \`Angemeldet als <strong>\${ME.name}</strong> (<code>\${ME.role}</code>)\` + (ME.impersonatedUserId ? ' (Impersonate)' : '');
      document.getElementById('pwChange').style.display = j.forcePasswordReset ? 'block' : 'none';
      document.getElementById('adminTools').style.display = (j.role === 'ADMIN') ? 'block' : 'none';
    }
    guard();

    async function loadMonth(){
      const month = document.getElementById('month').value;
      const userId = document.getElementById('userId').value;
      const q = new URLSearchParams({month, ...(userId?{userId}:{})}).toString();
      const r = await fetch('/api/timesheets?'+q);
      const j = await r.json();
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      for (const row of j.items){
        const tr = document.createElement('tr');
        const admin = ME.role==='ADMIN';
        tr.innerHTML = \`
          <td><input value="\${row.date}" class="inDate" \${admin?'':'disabled'}></td>
          <td>
            <select class="inType" \${admin?'':'disabled'}>
              <option \${row.type==='WORK'?'selected':''}>WORK</option>
              <option \${row.type==='URLAUB'?'selected':''}>URLAUB</option>
              <option \${row.type==='KRANK'?'selected':''}>KRANK</option>
            </select>
          </td>
          <td><input type="number" step="0.25" value="\${row.hours}" class="inHours" \${admin?'':'disabled'}></td>
          <td><input value="\${row.note||''}" class="inNote" \${admin?'':'disabled'}></td>
          <td>\${admin?'<button class="btnSave" data-id="'+row.id+'">Speichern</button>':''}</td>
        \`;
        tbody.appendChild(tr);
        const btn = tr.querySelector('.btnSave');
        if (btn){
          btn.onclick = async () => {
            const payload = {
              date: tr.querySelector('.inDate').value,
              type: tr.querySelector('.inType').value,
              hours: parseFloat(tr.querySelector('.inHours').value||0),
              note: tr.querySelector('.inNote').value
            };
            const r2 = await fetch('/api/timesheets/'+btn.dataset.id, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            alert(r2.ok?'Gespeichert':'Fehler');
          };
        }
      }
    }
    document.getElementById('btnLoad').onclick = loadMonth;
    loadMonth();

    document.getElementById('btnAdd').onclick = async ()=>{
      const payload = {
        date: document.getElementById('dDate').value,
        type: document.getElementById('dType').value,
        hours: parseFloat(document.getElementById('dHours').value||0),
        note: document.getElementById('dNote').value,
      };
      const uid = document.getElementById('dUserId').value;
      if (uid) payload.userId = parseInt(uid);
      const r = await fetch('/api/timesheets', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      alert(r.ok ? 'Hinzugefügt' : 'Fehler');
      if (r.ok) loadMonth();
    };

    document.getElementById('btnPwChange').onclick = async ()=>{
      const r = await fetch('/api/password-change', {method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({oldPassword: document.getElementById('oldpw').value, newPassword: document.getElementById('newpw').value})});
      alert(r.ok?'Passwort geändert':'Fehler');
      if (r.ok) guard();
    };

    document.getElementById('btnCreateUser').onclick = async ()=>{
      const payload = {
        name: document.getElementById('newName').value,
        email: document.getElementById('newEmail').value,
        password: document.getElementById('newPw').value,
        role: document.getElementById('newRole').value,
        team_id: document.getElementById('newTeam').value ? parseInt(document.getElementById('newTeam').value) : null
      };
      const r = await fetch('/api/users', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      alert(r.ok ? 'User angelegt' : 'Fehler');
    };
    document.getElementById('btnSetRole').onclick = async ()=>{
      const id = document.getElementById('roleUserId').value;
      const payload = { role: document.getElementById('roleRole').value, team_id: document.getElementById('roleTeam').value?parseInt(document.getElementById('roleTeam').value):null };
      const r = await fetch('/api/users/'+id+'/role', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      alert(r.ok ? 'Rolle gesetzt' : 'Fehler');
    };
    document.getElementById('btnImpersonate').onclick = async ()=>{
      const id = parseInt(document.getElementById('impUserId').value);
      const r = await fetch('/api/admin/impersonate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({userId:id})});
      alert(r.ok ? 'Impersonate aktiv' : 'Fehler');
      if (r.ok) guard();
    };
  </script>
</body>
</html>
