<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard • Zeiterfassung V32</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header><strong>Dashboard</strong></header>
  <main>
    <div class="card" id="welcome"></div>

    <div id="pwChangeCard" class="card" style="display:none;">
      <h3>Passwort ändern (Erstlogin)</h3>
      <div class="row">
        <input id="oldpw" type="password" placeholder="Altes Passwort">
        <input id="newpw" type="password" placeholder="Neues Passwort">
        <button id="btnPwChange">Speichern</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <input id="month" value="2025-10">
        <input id="userId" placeholder="User-ID (optional)">
        <button id="btnLoad">Monat laden</button>
      </div>
      <table id="tbl">
        <thead><tr><th>Datum</th><th>Typ</th><th>Stunden</th><th>Notiz</th><th class="muted">Aktion</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Eintrag hinzufügen</h3>
      <div class="row">
        <input id="dDate" value="2025-10-04">
        <select id="dType"><option>WORK</option><option>URLAUB</option><option>KRANK</option></select>
        <input id="dHours" type="number" step="0.25" value="8">
        <input id="dNote" placeholder="Notiz">
        <input id="dUserId" placeholder="für User-ID (optional)">
        <button id="btnAdd">Hinzufügen</button>
      </div>
    </div>

    <div class="card" id="adminTools" style="display:none;">
      <h3>Admin-Tools</h3>
      <div class="row">
        <input id="newName" placeholder="Name">
        <input id="newEmail" placeholder="E-Mail">
        <input id="newPw" placeholder="Passwort" value="pass123">
        <select id="newRole"><option>MITARBEITER</option><option>TEAMLEITER</option><option>ADMIN</option></select>
        <input id="newTeam" placeholder="Team-ID (optional)">
        <button id="btnCreateUser">User anlegen</button>
      </div>
      <div class="row">
        <input id="roleUserId" placeholder="User-ID">
        <select id="roleRole"><option>MITARBEITER</option><option>TEAMLEITER</option><option>ADMIN</option></select>
        <input id="roleTeam" placeholder="Team-ID (optional)">
        <button id="btnSetRole">Rolle setzen</button>
      </div>
      <div class="row">
        <input id="impUserId" placeholder="User-ID für Impersonate">
        <button id="btnImpersonate">Als Benutzer anmelden</button>
      </div>
    </div>
  </main>
  <script>
    let ME = null;
    async function guard(){
      const r = await fetch('/api/guard');
      if (r.status === 401) { location.href='/login.html'; return; }
      const j = await r.json();
      ME = j.user;
      document.getElementById('welcome').innerHTML = \`Angemeldet als <strong>\${ME.name}</strong> (<code>\${ME.role}</code>)\` + (ME.impersonatedUserId ? ' <span class="muted">(Impersonate)</span>' : '');
      document.getElementById('pwChangeCard').style.display = j.forcePasswordReset ? 'block' : 'none';
      document.getElementById('adminTools').style.display = (j.role === 'ADMIN') ? 'block' : 'none';
    }
    guard();

    async function loadMonth(){
      const month = document.getElementById('month').value;
      const userId = document.getElementById('userId').value;
      const q = new URLSearchParams({month, ...(userId?{userId}:{})}).toString();
      const r = await fetch('/api/timesheets?'+q);
      const j = await r.json();
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      for (const row of j.items){
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td><input value="\${row.date}" data-id="\${row.id}" class="inDate" \${ME.role!=='ADMIN'?'disabled':''}></td>
          <td>
            <select data-id="\${row.id}" class="inType" \${ME.role!=='ADMIN'?'disabled':''}>
              <option \${row.type==='WORK'?'selected':''}>WORK</option>
              <option \${row.type==='URLAUB'?'selected':''}>URLAUB</option>
              <option \${row.type==='KRANK'?'selected':''}>KRANK</option>
            </select>
          </td>
          <td><input type="number" step="0.25" value="\${row.hours}" data-id="\${row.id}" class="inHours" \${ME.role!=='ADMIN'?'disabled':''}></td>
          <td><input value="\${row.note||''}" data-id="\${row.id}" class="inNote" \${ME.role!=='ADMIN'?'disabled':''}></td>
          <td class="muted">\${ME.role==='ADMIN' ? '<button class="btnSave" data-id="'+row.id+'">Speichern</button>' : ''}</td>
        \`;
        tbody.appendChild(tr);
      }
      for (const b of document.querySelectorAll('.btnSave')){
        b.onclick = async (e)=>{
          const id = e.target.dataset.id;
          const tr = e.target.closest('tr');
          const payload = {
            date: tr.querySelector('.inDate').value,
            type: tr.querySelector('.inType').value,
            hours: parseFloat(tr.querySelector('.inHours').value||0),
            note: tr.querySelector('.inNote').value
          };
          const r = await fetch('/api/timesheets/'+id, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
          if (!r.ok){ alert('Fehler beim Speichern'); } else { alert('Gespeichert'); }
        };
      }
    }
    document.getElementById('btnLoad').onclick = loadMonth;
    loadMonth();

    document.getElementById('btnAdd').onclick = async ()=>{
      const payload = {
        date: document.getElementById('dDate').value,
        type: document.getElementById('dType').value,
        hours: parseFloat(document.getElementById('dHours').value||0),
        note: document.getElementById('dNote').value,
      };
      const uid = document.getElementById('dUserId').value;
      if (uid) payload.userId = parseInt(uid);
      const r = await fetch('/api/timesheets', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if (r.ok){ alert('Hinzugefügt'); loadMonth(); } else { alert('Fehler'); }
    };

    document.getElementById('btnPwChange').onclick = async ()=>{
      const r = await fetch('/api/password-change', {method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({oldPassword: document.getElementById('oldpw').value, newPassword: document.getElementById('newpw').value})});
      if (r.ok){ alert('Passwort geändert'); guard(); } else { alert('Fehler beim Ändern'); }
    };

    // Admin tools
    document.getElementById('btnCreateUser').onclick = async ()=>{
      const payload = {
        name: document.getElementById('newName').value,
        email: document.getElementById('newEmail').value,
        password: document.getElementById('newPw').value,
        role: document.getElementById('newRole').value,
        team_id: document.getElementById('newTeam').value ? parseInt(document.getElementById('newTeam').value) : null
      };
      const r = await fetch('/api/users', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if (r.ok){ alert('User angelegt'); } else { alert('Fehler beim Anlegen'); }
    };
    document.getElementById('btnSetRole').onclick = async ()=>{
      const id = document.getElementById('roleUserId').value;
      const payload = { role: document.getElementById('roleRole').value, team_id: document.getElementById('roleTeam').value?parseInt(document.getElementById('roleTeam').value):null };
      const r = await fetch('/api/users/'+id+'/role', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      alert(r.ok ? 'Rolle gesetzt' : 'Fehler beim Setzen');
    };
    document.getElementById('btnImpersonate').onclick = async ()=>{
      const id = parseInt(document.getElementById('impUserId').value);
      const r = await fetch('/api/admin/impersonate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({userId:id})});
      if (r.ok){ alert('Impersonate aktiv'); guard(); } else { alert('Fehler'); }
    };
  </script>
</body>
</html>
