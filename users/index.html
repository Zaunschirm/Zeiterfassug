<!doctype html><html lang="de"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mitarbeiterverwaltung – V58</title><link rel="icon" href="/Zeiterfassung/assets/logo.png">
<style>:root{--bg:#faf6f6;--ink:#1d1d1d;--card:#fff;--line:#ddd;--btn:#8c7b6a;--brand:#2b261f;--mut:#666}
*{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
header{background:#d9c9b9;color:var(--brand);padding:10px 14px;display:flex;gap:12px;justify-content:space-between;align-items:center}
header a, header button.link{color:var(--brand);text-decoration:none;background:transparent;border:0;padding:0;cursor:pointer;font:inherit}
.wrap{max-width:1080px;margin:16px auto;padding:0 12px}.card{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin:12px 0}
label{display:block;font-size:12px;margin-bottom:4px;color:#555}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit}
button{background:var(--btn);color:#fff;border:0;padding:10px 16px;border-radius:12px;font:inherit;cursor:pointer}
button.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
.row{display:grid;gap:12px}.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:820px){.row-2,.row-3{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse;margin-top:12px}th,td{border-bottom:1px solid var(--line);text-align:left;padding:10px;font-size:14px}
.muted{color:var(--mut)}
</style></head><body>
<header>
  <strong>Mitarbeiterverwaltung</strong>
  <nav style="display:flex;gap:12px;align-items:center">
    <a href="/Zeiterfassung/">← Zurück</a>
    <span id="who" class="muted"></span>
  </nav>
</header>

<main class="wrap">
  <section class="card">
    <h3>Neuen Benutzer anlegen</h3>
    <div class="row row-3">
      <div><label>Benutzername</label><input id="nuUser" placeholder="z. B. stefan"></div>
      <div><label>Anzeigename</label><input id="nuName" placeholder="z. B. Stefan"></div>
      <div><label>Passwort (leer = 1234)</label><input id="nuPass" type="password" placeholder="z. B. starkes PW"></div>
    </div>
    <div class="row row-2" style="margin-top:8px">
      <div><label>Rolle</label>
        <select id="nuRole"><option value="mitarbeiter">Mitarbeiter</option><option value="teamleiter">Teamleiter</option><option value="admin">Admin</option></select>
      </div>
      <div style="display:flex;align-items:end"><button id="btnAdd">Anlegen</button></div>
    </div>
  </section>

  <section class="card">
    <h3>Benutzerliste</h3>
    <div id="grid">
      <table>
        <thead><tr><th>Benutzername</th><th>Anzeigename</th><th>Rolle</th><th>Status</th><th>Aktion</th></tr></thead>
        <tbody id="tbl"></tbody>
      </table>
    </div>
    <p class="muted">Aktionen: Rolle/Status ändern, Passwort zurücksetzen auf 1234, Benutzer löschen.</p>
  </section>
</main>

<script>
const DB_NAME='zeit-web-pwa2'; const STORE={users:'users'};
const os=(db,n,m='readonly')=>db.transaction(n,m).objectStore(n);
const me=()=>{try{return JSON.parse(localStorage.getItem('cu2')||'null');}catch(_){return null;}};

function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1); r.onerror=()=>rej(r.error); r.onsuccess=()=>res(r.result); r.onupgradeneeded=e=>{const db=e.target.result; if(!db.objectStoreNames.contains(STORE.users)){const s=db.createObjectStore(STORE.users,{keyPath:'username'}); s.createIndex('role','role',{unique:false});}}});}

async function requireAdmin(){
  const u=me(); if(!u){ alert('Bitte erst in der Haupt-App anmelden.'); location.href='/Zeiterfassung/'; return false; }
  if(u.role!=='admin'){ alert('Nur Administratoren dürfen die Mitarbeiterverwaltung öffnen.'); location.href='/Zeiterfassung/'; return false; }
  document.getElementById('who').textContent=u.display||u.username; return true;
}

async function listUsers(){
  const db=await openDB(); const s=os(db,STORE.users); const rows=[];
  await new Promise((res,rej)=>{const r=s.openCursor(); r.onsuccess=e=>{const c=e.target.result; if(c){rows.push(c.value); c.continue();} else res();}; r.onerror=()=>rej(r.error);});
  rows.sort((a,b)=>a.username.localeCompare(b.username));
  const tb=document.getElementById('tbl'); tb.innerHTML=''; for(const u of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${u.username}</td><td>${u.display||''}</td>
      <td><select data-act="role" data-id="${u.username}"><option value="mitarbeiter">Mitarbeiter</option><option value="teamleiter">Teamleiter</option><option value="admin">Admin</option></select></td>
      <td><select data-act="stat" data-id="${u.username}"><option value="active">aktiv</option><option value="inactive">inaktiv</option></select></td>
      <td style="display:flex;gap:8px">
        <button data-act="reset" data-id="${u.username}" class="ghost">Passwort 1234</button>
        <button data-act="del" data-id="${u.username}" class="ghost">Löschen</button>
      </td>`;
    tb.appendChild(tr);
    tr.querySelector('[data-act="role"]').value=u.role||'mitarbeiter';
    tr.querySelector('[data-act="stat"]').value=u.status||'active';
  }
}

async function addUser(){
  const username=document.getElementById('nuUser').value.trim();
  const display=document.getElementById('nuName').value.trim();
  const pass=document.getElementById('nuPass').value.trim()||'1234';
  const role=document.getElementById('nuRole').value;
  if(!username){alert('Benutzername fehlt');return;}
  const db=await openDB();
  await new Promise((res,rej)=>{const r=os(db,STORE.users,'readwrite').put({username,display,pass,role,status:'active'}); r.onsuccess=res; r.onerror=()=>rej(r.error);});
  document.getElementById('nuUser').value=''; document.getElementById('nuName').value=''; document.getElementById('nuPass').value='';
  await listUsers();
}

async function updateUser(username,patch){
  const db=await openDB(); const s=os(db,STORE.users);
  const u=await new Promise((res,rej)=>{const r=s.get(username); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});
  if(!u) return;
  Object.assign(u,patch);
  await new Promise((res,rej)=>{const r=os(db,STORE.users,'readwrite').put(u); r.onsuccess=res; r.onerror=()=>rej(r.error);});
}

async function delUser(username){
  if(!confirm('Benutzer wirklich löschen?')) return;
  const db=await openDB();
  await new Promise((res,rej)=>{const r=os(db,STORE.users,'readwrite').delete(username); r.onsuccess=res; r.onerror=()=>rej(r.error);});
  await listUsers();
}

window.addEventListener('DOMContentLoaded', async ()=>{
  if(!await requireAdmin()) return;
  await listUsers();
  document.getElementById('btnAdd').onclick=addUser;
  document.getElementById('grid').addEventListener('change', async e=>{
    const t=e.target, id=t.getAttribute('data-id'); if(!id) return;
    if(t.getAttribute('data-act')==='role') await updateUser(id,{role:t.value});
    if(t.getAttribute('data-act')==='stat') await updateUser(id,{status:t.value});
  });
  document.getElementById('grid').addEventListener('click', async e=>{
    const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id');
    if(btn.getAttribute('data-act')==='reset'){ await updateUser(id,{pass:'1234'}); alert('Passwort gesetzt: 1234'); }
    if(btn.getAttribute('data-act')==='del'){ await delUser(id); }
  });
});
</script>
</body></html>
