<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cloud Sync – Arbeit & Zeit</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
<header class="topbar">
  <div class="brand"><span class="logo-dot"></span><span class="brand-text">Arbeitseinteilung und Zeiterfassung Holzbau Zaunschirm</span></div>
  <nav class="nav">
    <a href="dashboard.html">Übersicht</a>
    <a href="mitarbeiter.html" class="require-role-admin">Mitarbeiter</a>
    <a href="zeiterfassung.html">Zeiterfassung</a>
    <a href="plan.html">Wocheneinteilung</a>
    <a href="reports.html" class="require-role-admin">Berichte</a>
    <a href="backup.html" class="require-role-admin">Backup</a>
    <a href="cloud.html" class="require-role-admin">Cloud</a>
    <button id="logoutBtn" class="btn-ghost">Logout</button>
  </nav>
</header>
<main class="container">
  <section class="card">
    <h1>Cloud-Synchronisation</h1>
    <p>Einmalig Firebase-Projektdaten eintragen, einen <strong>Firmen-Schlüssel</strong> (z. B. <code>zaunschirm</code>) vergeben und aktivieren – dann sind die Daten auf allen Geräten gleich.</p>
    <div class="row wrap">
      <label>Aktiviert <input type="checkbox" id="enabled"></label>
      <label>Firmen-Schlüssel <input id="companyKey" placeholder="z. B. zaunschirm"></label>
    </div>
    <details open>
      <summary><strong>Firebase Konfiguration</strong></summary>
      <div class="row wrap">
        <label>apiKey <input id="apiKey"></label>
        <label>authDomain <input id="authDomain"></label>
        <label>projectId <input id="projectId"></label>
        <label>storageBucket <input id="storageBucket"></label>
        <label>messagingSenderId <input id="messagingSenderId"></label>
        <label>appId <input id="appId"></label>
      </div>
    </details>
    <div class="row" style="margin-top:10px">
      <button id="saveBtn" class="btn-primary">Speichern</button>
      <button id="testBtn" class="btn">Verbindung testen</button>
    </div>
    <p id="out" style="margin-top:8px; color:#2F3438"></p>
  </section>
</main>
<footer class="footer"><small>© 2025 Holzbau Zaunschirm • Cloud</small></footer>
<script defer src="js/storage.js?v=03a?v=02c"></script>
<script defer src="js/auth.js?v=03a?v=02c"></script>
<script defer src="js/app.js?v=03a?v=02c"></script>
<script defer src="js/cloud.js?v=03a"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  protectPage(['admin']); renderNavByRole();
  const s = JSON.parse(localStorage.getItem('z_cloud_settings')||'{}');
  enabled.checked = !!s.enabled;
  companyKey.value = s.companyKey || '';
  const c = s.config || {};
  apiKey.value = c.apiKey||''; authDomain.value=c.authDomain||''; projectId.value=c.projectId||''; storageBucket.value=c.storageBucket||''; messagingSenderId.value=c.messagingSenderId||''; appId.value=c.appId||'';

  saveBtn.addEventListener('click', ()=>{
    const cfg = { apiKey: apiKey.value.trim(), authDomain: authDomain.value.trim(), projectId: projectId.value.trim(), storageBucket: storageBucket.value.trim(), messagingSenderId: messagingSenderId.value.trim(), appId: appId.value.trim() };
    if(!companyKey.value.trim()){ out.textContent='Bitte Firmen-Schlüssel angeben.'; return; }
    saveCloudSettings(enabled.checked, companyKey.value.trim(), cfg);
    out.textContent = 'Gespeichert. Geräte mit gleichem Schlüssel synchronisieren automatisch.';
  });

  testBtn.addEventListener('click', async ()=>{
    try{
      const s = JSON.parse(localStorage.getItem('z_cloud_settings')||'{}');
      if(!s.enabled) { out.textContent='Cloud ist nicht aktiviert.'; return; }
      window.CLOUD.enabled = !!s.enabled; window.CLOUD.companyKey = s.companyKey; window.CLOUD.config = s.config;
      await cloudInitIfNeeded();
      await cloudSaveFull({ users: readUsers(), times: readTimes(), plan: readPlan(), projects: readProjects() });
      out.textContent = 'Verbindung in Ordnung. Aktueller Stand wurde testweise hochgeladen.';
    }catch(e){ out.textContent = 'Fehler: '+e.message; }
  });
});
</script>
</body>
</html>
